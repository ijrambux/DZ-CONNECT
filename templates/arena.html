<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Arena | DZ-CONNECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; padding: 0;
            background: url('https://z-cdn-media.chatglm.cn/files/df4cae94-bae5-4bf1-8d51-54a2fb4429b7.jpg?auth_key=1867320284-a137d941c33b45ccabec0925b6873bf1-0-677147ce5499656f976e32cfdda66079') no-repeat center center fixed;
            background-size: cover;
            color: white; font-family: 'Cairo', sans-serif; 
            min-height: 100vh;
            overflow: hidden; 
        }
        body::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 10, 20, 0.6); z-index: -1;
        }

        /* --- Domino Styles (ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑŸáÿß ŸÑŸÑÿ£ÿ≤ÿ±ŸÇ ÿßŸÑŸÑÿßŸÖÿπ) --- */
        .tile {
            width: 50px; height: 100px;
            background: rgba(0, 10, 25, 0.95);
            border: 1px solid #00f2ff; /* ÿ≠ÿØŸàÿØ ÿ≥ŸÖÿßŸàŸäÿ© ŸÑÿßŸÖÿπÿ© */
            border-radius: 8px;
            display: flex; flex-direction: column; justify-content: space-around; align-items: center;
            cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); /* ÿ™ŸàŸáÿ¨ ŸÇŸàŸä */
            transition: 0.2s;
            position: relative;
        }
        .tile:hover { 
            transform: translateY(-5px) scale(1.1); 
            border-color: #ffffff; /* Ÿäÿ™ÿ≠ŸàŸÑ ŸÑŸÑÿ£ÿ®Ÿäÿ∂ ÿπŸÜÿØ ÿßŸÑŸÖÿ±Ÿàÿ± */
            box-shadow: 0 0 25px rgba(0, 242, 255, 0.7); 
            z-index: 10;
        }
        .tile.disabled { 
            opacity: 0.3; pointer-events: none; border-color: #333; box-shadow: none; 
        }
        .tile-horizontal { width: 100px; height: 50px; flex-direction: row; }
        
        /* ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ≤ÿ±ŸÇÿßÿ° */
        .dot { 
            width: 8px; height: 8px; 
            background: #00f2ff; 
            border-radius: 50%; 
            box-shadow: 0 0 8px #00f2ff; /* ÿ™ŸàŸáÿ¨ ÿßŸÑŸÜŸÇÿßÿ∑ */
        }
        
        /* --- Chat Styles --- */
        audio { height: 30px; width: 100%; filter: invert(1) sepia(1) saturate(5) hue-rotate(175deg); }
        .mic-btn.recording { background: #ef4444; animation: pulse-rec 1.5s infinite; }
        @keyframes pulse-rec {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        #visualizer { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); width: 150px; height: 40px; pointer-events: none; z-index: 50; display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="flex justify-between items-center p-4 bg-black/40 backdrop-blur-md border-b border-cyan-500/20 z-50">
        <div class="flex items-center gap-4">
            <a href="/hub" class="text-gray-400 hover:text-white font-bold text-sm">‚Üê BACK TO HUB</a>
            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 uppercase tracking-widest">
                NEON ARENA
            </h1>
        </div>
        <div class="flex gap-4 text-xs font-bold">
            <span class="text-cyan-400">PLAY: <span id="p-count">7</span></span>
            <span class="text-gray-500">CPU: <span id="c-count">7</span></span>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 overflow-hidden">
        
        <!-- Game Section (Left - Larger) -->
        <div class="lg:col-span-3 relative flex flex-col bg-black/20 m-4 rounded-3xl border border-white/5 backdrop-blur-md overflow-hidden">
            
            <!-- CPU Area -->
            <div class="h-20 flex justify-center gap-2 p-2 opacity-60 select-none">
                <div id="cpu-hand" class="flex gap-1"></div>
            </div>

            <!-- Game Board -->
            <div class="flex-1 overflow-x-auto overflow-y-hidden p-4 flex items-center relative">
                <div id="game-board" class="flex gap-1 min-w-max mx-auto transition-all duration-500"></div>
                <div id="game-status" class="absolute top-2 left-1/2 -translate-x-1/2 bg-black/80 px-4 py-1 rounded-full border border-cyan-500 text-cyan-400 text-sm font-bold tracking-wider animate-pulse">
                    YOUR TURN
                </div>
            </div>

            <!-- Player Hand -->
            <div class="h-40 bg-black/40 border-t border-white/10 p-4 relative">
                <div id="player-hand" class="flex justify-center gap-3 overflow-x-auto pb-2"></div>
                <button onclick="drawTile()" class="absolute bottom-4 left-4 w-12 h-12 rounded-xl bg-cyan-900 border border-cyan-500 text-white font-bold hover:bg-cyan-700 active:scale-95 shadow-lg">‚Üª</button>
            </div>
        </div>

        <!-- Chat Section (Right - Sidebar) -->
        <div class="lg:col-span-1 bg-black/40 m-4 mt-4 lg:mt-4 mb-4 rounded-3xl border border-cyan-500/20 backdrop-blur-xl flex flex-col">
            <!-- Messages -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
                <div class="text-center text-xs text-gray-500 font-bold mt-4">ARENA CHAT ACTIVE</div>
            </div>
            
            <!-- Input Area -->
            <div class="absolute bottom-8 right-8 w-full max-w-[300px] lg:max-w-none p-2">
                <div class="bg-gray-900/80 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-2 flex items-center gap-2 shadow-[0_0_20px_rgba(0,242,255,0.1)]">
                    
                    <button id="mic-btn" onclick="toggleRecording()" class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-600 to-blue-700 flex items-center justify-center text-xl hover:scale-105 transition-all">
                        üé§
                    </button>
                    
                    <input id="msg-input" type="text" placeholder="Say something..." class="flex-grow bg-transparent border-none outline-none text-sm text-white font-bold">
                    
                    <button onclick="sendText()" class="w-8 h-8 rounded-lg bg-cyan-600 text-white text-xs font-bold hover:bg-cyan-500">‚û§</button>
                </div>

                <!-- Audio Visualizer (Hidden) -->
                <canvas id="visualizer"></canvas>
                
                <!-- Preview Controls (Hidden) -->
                <div id="preview-controls" class="hidden absolute bottom-14 right-2 flex gap-2">
                    <button onclick="cancelAudio()" class="text-red-500 text-xs font-bold px-2">‚úï</button>
                    <button onclick="sendAudio()" class="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ================= GAME LOGIC (DOMINO) ================= */
        const deck = []; let board = []; let pHand = [], cHand = []; let isTurn = true;
        
        function initDeck() {
            deck.length=0;
            for(let i=0;i<=6;i++) for(let j=i;j<=6;j++) deck.push({t:i,b:j,id:`${i}-${j}`});
        }
        function shuffle(d){for(let i=d.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}}
        
        function createTile(t, h=false){
            let d=document.createElement('div');
            d.className=`tile ${h?'tile-horizontal':''}`;
            // ÿ±ÿ≥ŸÖ ÿßŸÑŸÜŸÇÿßÿ∑ (ÿßŸÑÿ¢ŸÜ ÿ≥ÿ™ÿ∏Ÿáÿ± ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ ÿ®ÿ≥ÿ®ÿ® CSS)
            let dots = '<div class="dot"></div>'.repeat(t.t) + (h?'':'<hr style="width:80%;border-color:rgba(0,242,255,0.3)">') + '<div class="dot"></div>'.repeat(t.b);
            d.innerHTML = dots;
            return d;
        }
        
        function renderBoard(){
            const b=document.getElementById('game-board');
            b.innerHTML='';
            board.forEach(x=>{
                let el=createTile(x.tile,true);
                if(x.f) el.style.transform='rotate(180deg)';
                b.appendChild(el);
            });
        }
        
        function renderHand(){
            const h=document.getElementById('player-hand');
            h.innerHTML='';
            pHand.forEach(t=>{
                let el=createTile(t);
                el.onclick=()=>playTile(t);
                if(board.length>0){
                    let l=board[0].tile.t, r=board[board.length-1].tile.b;
                    if(t.t!=l && t.b!=l && t.t!=r && t.b!=r) el.classList.add('disabled');
                }
                h.appendChild(el);
            });
            // Update CPU visual (backs)
            const c=document.getElementById('cpu-hand');
            c.innerHTML='';
            for(let i=0;i<cHand.length;i++){
                let div=document.createElement('div');
                div.className='tile tile-center bg-gray-800 border-gray-600';
                c.appendChild(div);
            }
            document.getElementById('p-count').innerText=pHand.length;
            document.getElementById('c-count').innerText=cHand.length;
        }

        function playTile(t){
            if(!isTurn) return;
            if(board.length===0){
                board.push({tile:t,f:false});
                pHand.splice(pHand.indexOf(t),1);
                endTurn(); return;
            }
            let l=board[0].tile.t, r=board[board.length-1].tile.b;
            let played=false;
            // Try Right
            if(t.t===r){ board.push({tile:t,f:false}); played=true; }
            else if(t.b===r){ board.push({tile:t,f:true}); played=true; }
            // Try Left
            else if(t.b===l){ board.unshift({tile:t,f:false}); played=true; }
            else if(t.t===l){ board.unshift({tile:t,f:true}); played=true; }
            
            if(played){
                pHand.splice(pHand.indexOf(t),1);
                endTurn();
            }
        }

        function drawTile(){
            if(!isTurn || deck.length===0) return;
            let t=deck.pop(); pHand.push(t);
            renderHand();
        }

        function endTurn(){
            renderBoard(); renderHand();
            if(pHand.length===0) { alert("YOU WIN!"); initGame(); return; }
            isTurn=false;
            document.getElementById('game-status').innerText="CPU THINKING...";
            document.getElementById('game-status').className="absolute top-2 left-1/2 -translate-x-1/2 bg-black/80 px-4 py-1 rounded-full border border-red-500 text-red-400 text-sm font-bold tracking-wider animate-pulse";
            setTimeout(cpuMove,1500);
        }

        function cpuMove(){
            let l=board[0].tile.t, r=board[board.length-1].tile.b;
            let played=false;
            for(let i=0;i<cHand.length;i++){
                let t=cHand[i];
                if(t.t===r){ board.push({tile:t,f:false}); cHand.splice(i,1); played=true; break; }
                if(t.b===r){ board.push({tile:t,f:true}); cHand.splice(i,1); played=true; break; }
                if(t.b===l){ board.unshift({tile:t,f:false}); cHand.splice(i,1); played=true; break; }
                if(t.t===l){ board.unshift({tile:t,f:true}); cHand.splice(i,1); played=true; break; }
            }
            if(played){
                renderBoard();
                if(cHand.length===0){ alert("CPU WINS!"); initGame(); return; }
            } else if(deck.length>0){
                cHand.push(deck.pop()); renderHand();
                setTimeout(cpuMove,1000);
            } else {
                alert("CPU PASS");
            }
            isTurn=true;
            document.getElementById('game-status').innerText="YOUR TURN";
            document.getElementById('game-status').className="absolute top-2 left-1/2 -translate-x-1/2 bg-black/80 px-4 py-1 rounded-full border border-cyan-500 text-cyan-400 text-sm font-bold tracking-wider animate-pulse";
        }

        function initGame(){
            initDeck(); shuffle(deck);
            pHand=deck.splice(0,7); cHand=deck.splice(0,7); board=[];
            isTurn=true; renderHand(); renderBoard();
        }
        initGame();


        /* ================= CHAT LOGIC (AUDIO) ================= */
        let rec, chunks, audioBlob, audioUrl, audioCtx, analyser, mic, scriptNode, isRec=false;
        const visCanvas=document.getElementById('visualizer'); const vCtx=visCanvas.getContext('2d');

        async function toggleRecording(){
            if(!isRec){
                try{
                    const s=await navigator.mediaDevices.getUserMedia({audio:true});
                    audioCtx=new AudioContext(); analyser=audioCtx.createAnalyser();
                    mic=audioCtx.createMediaStreamSource(s); scriptNode=audioCtx.createScriptProcessor(2048,1,1);
                    analyser.smoothingTimeConstant=0.8; analyser.fftSize=512;
                    mic.connect(analyser); analyser.connect(scriptNode); scriptNode.connect(audioCtx.destination);
                    
                    scriptNode.onaudioprocess=()=>{
                        let arr=new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr);
                        drawVis(arr);
                    };
                    
                    rec=new MediaRecorder(s); chunks=[];
                    rec.ondataavailable=e=>chunks.push(e.data);
                    rec.start(); isRec=true;
                    document.getElementById('mic-btn').classList.add('recording');
                    document.getElementById('preview-controls').classList.add('hidden');
                    visCanvas.style.display='block';
                }catch(e){alert("Mic Error");}
            } else {
                rec.stop(); isRec=false;
                document.getElementById('mic-btn').classList.remove('recording');
                mic.disconnect(); scriptNode.disconnect();
                audioBlob=new Blob(chunks,{type:'audio/webm'}); audioUrl=URL.createObjectURL(audioBlob);
                visCanvas.style.display='none';
                document.getElementById('preview-controls').classList.remove('hidden');
            }
        }

        function drawVis(arr){
            vCtx.clearRect(0,0,visCanvas.width,visCanvas.height);
            vCtx.fillStyle='#00f2ff';
            let w=visCanvas.width/arr.length;
            for(let i=0;i<arr.length;i++){
                vCtx.fillRect(i*w,visCanvas.height-arr[i]/4,w,arr[i]/4);
            }
        }

        function cancelAudio(){ audioBlob=null; document.getElementById('preview-controls').classList.add('hidden'); }
        
        async function sendAudio(){
            if(!audioBlob) return;
            let fd=new FormData(); fd.append('audio', audioBlob, 'voice.webm');
            await fetch('/api/chat',{method:'POST',body:fd});
            cancelAudio(); loadMsg();
        }

        async function sendText(){
            let i=document.getElementById('msg-input');
            if(!i.value) return;
            await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({msg:i.value})});
            i.value=''; loadMsg();
        }

        async function loadMsg(){
            try{
                let r=await fetch('/api/chat'); let d=await r.json();
                let b=document.getElementById('chat-box'); b.innerHTML='';
                d.forEach(m=>{
                    let div=document.createElement('div');
                    if(m.type=='audio'){
                        div.innerHTML=`<div class="text-[8px] font-bold text-cyan-400">${m.user}</div><audio controls src="${m.audio_url}"></audio>`;
                    }else{
                        div.innerHTML=`<div class="text-[8px] font-bold text-purple-400">${m.user}</div><div class="text-xs text-white">${m.text}</div>`;
                    }
                    div.className='bg-white/5 p-2 rounded-xl border border-white/5 backdrop-blur-md';
                    b.appendChild(div);
                });
                b.scrollTop=b.scrollHeight;
            }catch(e){}
        }
        setInterval(loadMsg,3000);

    </script>
</body>
</html>
