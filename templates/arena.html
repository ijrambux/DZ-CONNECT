<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Arena Live | Real 1v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- مكتبة Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { margin:0; padding:0; background: #00050a; color: white; font-family: 'Cairo', sans-serif; min-height: 100vh; overflow: hidden; }
        .tile { width: 50px; height: 100px; background: rgba(0,10,25,0.95); border: 1px solid #00f2ff; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; cursor: pointer; transition: 0.2s; }
        .tile:hover { transform: translateY(-5px) scale(1.1); z-index: 10; }
        .tile.disabled { opacity: 0.3; pointer-events: none; }
        .tile-horizontal { width: 100px; height: 50px; flex-direction: row; }
        .dot { width: 8px; height: 8px; background: #00f2ff; border-radius: 50%; box-shadow: 0 0 8px #00f2ff; }
        .enemy-tile { border-color: #ef4444; }
        .enemy-tile .dot { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-900">
    
    <!-- Header -->
    <header class="p-4 bg-black/50 border-b border-white/10 flex justify-between">
        <a href="/hub" class="text-gray-400 hover:text-white">← Hub</a>
        <div id="role-display" class="text-cyan-400 font-bold">Connecting...</div>
    </header>

    <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-4 p-4">
        <!-- Game Area -->
        <div class="lg:col-span-3 flex flex-col bg-black/20 rounded-2xl border border-white/5 relative">
            <div id="cpu-hand" class="h-20 flex justify-center gap-2 p-2 opacity-60"></div>
            <div id="game-board" class="flex-1 overflow-x-auto p-4 flex items-center"></div>
            <div class="h-40 bg-black/40 border-t p-4 relative">
                <div id="player-hand" class="flex justify-center gap-3 overflow-x-auto"></div>
                <button onclick="socket.emit('draw_tile')" class="absolute bottom-4 left-4 w-12 h-12 bg-blue-600 text-white rounded-xl">↻</button>
            </div>
        </div>

        <!-- Chat -->
        <div class="lg:col-span-1 bg-black/40 rounded-2xl p-2 flex flex-col">
            <div id="chat-box" class="flex-1 overflow-y-auto space-y-2 mb-2"></div>
            <input id="msg-input" type="text" placeholder="Say..." class="w-full p-2 bg-gray-800 rounded-lg outline-none text-white">
            <button onclick="sendText()" class="mt-2 w-full bg-blue-600 p-2 rounded-lg">Send</button>
        </div>
    </div>

    <script>
        // Socket Connection
        const socket = io();
        let myRole = "Spectator"; // Blue, Red, Spectator
        let mySid = null;
        let gameState = {};

        socket.on('connect', () => {
            mySid = socket.id;
            // أرسل اسمك للسيرفر ليتم تسجيلك
            // ملاحظة: في بيئة حقيقية، نأخذ الاسم من Session، هنا سنفترض "Guest" للتجربة
            socket.emit('join_arena', { username: 'Guest_' + mySid.substr(0,4) });
        });

        socket.on('player_role', (data) => {
            if(data.sid === mySid) {
                myRole = data.role;
                document.getElementById('role-display').innerText = "You are: " + data.role;
                if(data.role === 'Spectator') document.getElementById('role-display').className = "text-gray-500 font-bold";
                else document.getElementById('role-display').className = "text-cyan-400 font-bold";
            }
        });

        socket.on('game_state_update', (state) => {
            gameState = state;
            renderBoard();
            renderHand();
        });

        socket.on('game_over', (data) => {
            alert("Winner: " + data.winner);
        });

        // --- Rendering Logic (Same as before but uses gameState) ---
        function createTileObj(t, h=false, isEnemy=false){
            let d=document.createElement('div');
            d.className=`tile ${h?'tile-horizontal':''} ${isEnemy?'enemy-tile':''}`;
            // Simple drawing logic
            let dotsTop = '<div class="dot"></div>'.repeat(t.t);
            let dotsBot = '<div class="dot"></div>'.repeat(t.b);
            let separator = h?'':'<hr style="width:80%;border-color:rgba(255,255,255,0.2)">';
            d.innerHTML = dotsTop + separator + dotsBot;
            return d;
        }

        function renderBoard(){
            const b=document.getElementById('game-board');
            b.innerHTML='';
            if(gameState.board){
                gameState.board.forEach(x=>{
                    let el=createTileObj(x.tile,true);
                    if(x.flipped) el.style.transform='rotate(180deg)';
                    b.appendChild(el);
                });
            }
        }

        function renderHand(){
            const h=document.getElementById('player-hand');
            h.innerHTML='';
            const myHand = gameState.hands[mySid] || [];
            
            // Render Opponent Hand (Generic Backs)
            const enemyHand = document.getElementById('cpu-hand');
            enemyHand.innerHTML = '';
            if(gameState.players) {
                gameState.players.forEach(pSid => {
                    if(pSid !== mySid) {
                        for(let i=0; i<(gameState.hands[pSid]||[]).length; i++){
                            let div=document.createElement('div');
                            div.className='tile tile-center bg-gray-800 border-gray-600 opacity-50';
                            enemyHand.appendChild(div);
                        }
                    }
                });
            }

            // Render My Hand if I am Player
            if(myRole !== 'Spectator') {
                myHand.forEach(t=>{
                    let el=createTileObj(t);
                    el.onclick=()=>playTile(t);
                    // Disable if not my turn
                    if(gameState.turn !== mySid) el.classList.add('disabled');
                    h.appendChild(el);
                });
            } else {
                h.innerHTML = '<div class="text-gray-500 w-full text-center pt-10">You are spectating. Please wait for next round.</div>';
            }
        }

        function playTile(tile){
            if(myRole === 'Spectator') return;
            socket.emit('play_tile', {id: `${tile.t}-${tile.b}`});
        }

        // Chat Logic (Polling)
        async function loadMsg(){
            const r = await fetch('/api/chat'); const d = await r.json();
            const b = document.getElementById('chat-box'); b.innerHTML='';
            d.forEach(m=>{
                let div = document.createElement('div');
                div.className='bg-white/5 p-2 rounded-xl text-sm';
                div.innerHTML = `<b class="text-xs text-blue-400">${m.user}:</b> ${m.text}`;
                b.appendChild(div);
            });
            b.scrollTop=b.scrollHeight;
        }
        async function sendText(){
            const i=document.getElementById('msg-input');
            if(!i.value) return;
            await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({msg:i.value})});
            i.value=''; loadMsg();
        }
        setInterval(loadMsg, 3000);
    </script>
</body>
</html>
